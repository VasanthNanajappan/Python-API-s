<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tasks Consumer</title>
    <!-- Bootstrap CDN for styling -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Chart.js CDN for the chart -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Socket.io CDN for real-time communication -->
    <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
</head>
<body>
    <div class="content">
        <div id="Messages" class="content" style="height: 200px; width: 100%; border: 1px solid gray; overflow-y: scroll;"></div>
    </div>
    <div class="container mt-4">
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <canvas id="canvas"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- jQuery CDN for manipulating DOM -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Bootstrap JS CDN for interactivity -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        $(document).ready(function () {
            // Chart configuration
            const config = {
                type: 'bar',
                data: {
                    labels: ['Low', 'Moderate', 'Major', 'Critical'],
                    datasets: [{
                        label: "Count of Tasks",
                        backgroundColor: ['green', 'blue', 'yellow', 'red'],
                        borderColor: 'rgb(255, 99, 132)',
                        data: [0, 0, 0, 0],
                        fill: false,
                    }],
                },
                options: {
                    responsive: true,
                    title: {
                        display: true,
                        text: 'Tasks Priority Matrix',
                    },
                    tooltips: {
                        mode: 'index',
                        intersect: false,
                    },
                    hover: {
                        mode: 'nearest',
                        intersect: true,
                    },
                    scales: {
                        x: {
                            display: true,
                            scaleLabel: {
                                display: true,
                                labelString: 'Priority',
                            },
                        },
                        y: {
                            display: true,
                            ticks: {
                                beginAtZero: true,
                            },
                            scaleLabel: {
                                display: true,
                                labelString: 'Total',
                            },
                        },
                    },
                },
            };

            // Create the chart
            const context = document.getElementById('canvas').getContext('2d');
            const barChart = new Chart(context, config);

            // WebSocket setup
            const namespace = '/collectHooks';
            const url = 'http://' + document.domain + ':' + location.port + namespace;
            const socket = io.connect(url);

            // Join the WebSocket room on connection
            socket.on('connect', function () {
                socket.emit('join_room');
            });

            // Handle incoming messages
            socket.on('msg', function (data) {
                const msg = JSON.parse(data);
                console.log('Received message:', msg);  // Log incoming message to verify the structure

                // Create a new message line
                const newLine = $('<li>' +
                    'Batch ID = ' + msg.batchid +
                    ' -- Task ID = ' + msg.id +
                    ' -- Owner = ' + msg.owner +
                    ' -- Priority = ' + msg.priority +
                    '</li>');
                newLine.css("color", "blue");

                // Append the new message to the Messages container
                $("#Messages").append(newLine);

                // Ensure the priority is valid and update the chart
                const priorityIndex = config.data.labels.indexOf(msg.priority);
                if (priorityIndex !== -1) {
                    config.data.datasets[0].data[priorityIndex] += 1;
                    barChart.update();
                }
            });
        });
    </script>
</body>
</html>
